{% extends "cast/bootstrap5/base.html" %}
{% load i18n static wagtailcore_tags %}
{% load webmention_tags %}

{%block title %}{{ page.title }}{% endblock title %}

{% block meta %}
  {{ block.super }}
{% endblock %}

{% block bodystart %}
  <a
    href="https://fedi.wersdoerfer.de/@jochen"
    rel="me"
    class="visually-hidden"
    aria-label="Mastodon profile for Jochen Wersdoerfer"
  ></a>
{% endblock bodystart %}

{% block navigation %}
  <nav class="navbar navbar-expand-lg navbar-sticky">
    <div class="container-fluid">
      <a class="navbar-brand" href="{% url 'home' %}">Home</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="/blogs/ephes_blog/">Jochens Blog</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'jochen' %}">Jochen</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'katharina' %}">Katharina</a>
          </li>
          {% if request.user.is_authenticated %}
            <li class="nav-item">
              {# URL provided by django-allauth/account/urls.py #}
              <a class="nav-link" href="{% url 'account_logout' %}">{% trans "Sign Out" %}</a>
            </li>
          {% else %}
            <!--
              <li class="nav-item">
                {# URL provided by django-allauth/account/urls.py #}
                <a id="sign-up-link" class="nav-link" href="{% url 'account_signup' %}">{% trans "Sign Up" %}</a>
              </li>
            -->
            <li class="nav-item">
              {# URL provided by django-allauth/account/urls.py #}
              <a id="log-in-link" class="nav-link" href="{% url 'account_login' %}">{% trans "Sign In" %}</a>
            </li>
          {% endif %}
          {% if has_selectable_themes %}
            {% include "cast/bootstrap5/select_theme.html" %}
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>
{% endblock navigation%}

{% block template_script %}
  <script>
    (function () {
      'use strict';

      function buildOrderingDropdown() {
        var container = document.getElementById('div_id_o');
        if (!container || container.dataset.castOrderingEnhanced === 'true') {
          return;
        }
        var select = container.querySelector('select[name="o"]');
        if (!select) {
          return;
        }

        var label = container.querySelector('label[for="id_o"]');
        if (label && !label.id) {
          label.id = 'ordering-label';
        }

        var dropdown = document.createElement('div');
        dropdown.className = 'dropdown';

        var button = document.createElement('button');
        button.type = 'button';
        button.className = 'btn btn-outline-secondary dropdown-toggle w-100 text-start';
        button.setAttribute('data-bs-toggle', 'dropdown');
        button.setAttribute('aria-expanded', 'false');
        if (label && label.id) {
          button.setAttribute('aria-labelledby', label.id);
        }

        var menu = document.createElement('ul');
        menu.className = 'dropdown-menu w-100';

        var options = Array.prototype.slice.call(select.options);
        options.forEach(function (option) {
          var item = document.createElement('li');
          var itemButton = document.createElement('button');
          itemButton.type = 'button';
          itemButton.className = 'dropdown-item';
          itemButton.textContent = option.textContent;
          itemButton.setAttribute('data-order-value', option.value);
          if (option.selected) {
            itemButton.classList.add('active');
            button.textContent = option.textContent;
          }
          item.appendChild(itemButton);
          menu.appendChild(item);
        });

        if (!button.textContent) {
          button.textContent = options.length ? options[0].textContent : 'Ordering';
        }

        dropdown.appendChild(button);
        dropdown.appendChild(menu);
        select.parentNode.insertBefore(dropdown, select);

        menu.addEventListener('click', function (event) {
          var target = event.target.closest('[data-order-value]');
          if (!target) {
            return;
          }
          var value = target.getAttribute('data-order-value');
          select.value = value;
          button.textContent = target.textContent;
          Array.prototype.forEach.call(menu.querySelectorAll('.dropdown-item'), function (item) {
            item.classList.toggle('active', item === target);
          });
        });

        select.classList.add('visually-hidden');
        select.setAttribute('aria-hidden', 'true');
        container.dataset.castOrderingEnhanced = 'true';
      }

      function mergeConsecutiveBlockquotes() {
        var blockquotes = Array.prototype.slice.call(document.querySelectorAll('blockquote'));
        if (!blockquotes.length) {
          return;
        }

        function ensureParagraphs(bq) {
          var nodes = Array.prototype.slice.call(bq.childNodes);
          var hasElement = nodes.some(function (node) {
            return node.nodeType === Node.ELEMENT_NODE;
          });
          if (!hasElement) {
            var text = bq.textContent.trim();
            bq.textContent = '';
            if (text) {
              var p = document.createElement('p');
              p.textContent = text;
              bq.appendChild(p);
            }
            return;
          }

          nodes.forEach(function (node) {
            if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
              var p = document.createElement('p');
              p.textContent = node.textContent.trim();
              bq.replaceChild(p, node);
            }
          });
        }

        blockquotes.forEach(function (bq) {
          if (bq.dataset.castBlockquoteMerged === 'true') {
            return;
          }
          var next = bq.nextElementSibling;
          if (!next || next.tagName.toLowerCase() !== 'blockquote') {
            return;
          }

          ensureParagraphs(bq);
          while (next && next.tagName.toLowerCase() === 'blockquote') {
            ensureParagraphs(next);
            while (next.firstChild) {
              bq.appendChild(next.firstChild);
            }
            var toRemove = next;
            next = next.nextElementSibling;
            toRemove.remove();
          }
          bq.dataset.castBlockquoteMerged = 'true';
        });
      }

      function initEnhancements() {
        buildOrderingDropdown();
        mergeConsecutiveBlockquotes();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initEnhancements);
      } else {
        initEnhancements();
      }
    })();
  </script>
{% endblock template_script %}

{% block javascript %}
  {{ block.super }}
  <script async data-domain="wersdoerfer.de" src="https://plausible.io/js/script.js"></script>
{% endblock javascript %}
